---
title: "Nor-Solidarity PROM analysis report"
author: "Inge Christoffer Olsen, PhD"
date: '`r format(Sys.time(), "%d %B, %Y")` '
output:
  word_document:
    reference_docx: report_template.docx
    toc: TRUE
params:
  viedoc_export: ous_20210104_003034
  pseudorandom: FALSE
editor_options: 
  markdown: 
    wrap: 72
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE)
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
library(tidyverse)
library(ggformula)
library(wesanderson)
library(rlang)
library(glue)
library(knitr)
library(labelled)
library(survival)
library(survminer)
library(mice)
library(marginaleffects)
library(forestplot)

prom_seed <- 2023051 #Note that the seed misses an 8 on the end. Have run the code with the 8 without the results changing conclusions. 

```

```{r load-datasets, include = FALSE}

tddm <- read_rds("data/td/tddm.rds")
tdran <- read_rds("data/td/tdran.rds")
raw <- read_rds("data/raw/raw.rds")
adsl <- read_rds("data/ad/adsl.rds")
adsl_all <- read_rds("data/ad/adsl_all.rds")
adex <- read_rds("data/ad/adex.rds")
adae <- read_rds("data/ad/adae.rds")
tdex <- read_rds("data/td/tdex.rds")
addm <- read_rds("data/ad/addm.rds")
adev <- read_rds("data/ad/adev.rds")
tdds <- read_rds("data/td/tdds.rds")
adprom <- read_rds("data/ad/adprom.rds")
adprom_noimp <- read_rds("data/ad/adprom_noimp.rds")
source("src/external/functions.R")

source("src/External/functions.R", local = knitr::knit_global())
export_date = substr(params$viedoc_export,5,19) %>% lubridate::as_datetime()
if(params$pseudorandom) {
  pr_text = "While the results are based on real data, the treatment allocation has been drawn randomly for this report. Thus, this is a mock-up report intended to show how the final report will look, without showing the actual results of the trial and the treatment differences."
} else {
  pr_text = "The results in this report is according to the true random allocation. "
}
```

# Introduction

This is the report for the patient reported outcome measures (PROMs) in
the Nor-Solidarity trials. The data are based on an export from the
Viedoc electronic data capture at "`r export_date`" system time stamped
"`r params$viedoc_export`". `r pr_text` There were `r n_distinct(adsl)`
included patients. The EQ-5D and SF-36 data are gathered from the
Norwegian Intensive Care and Pandemic Registry in an export dated 20
April 2021. There were `r adprom %>% n_distinct()` subjects with at
least one PROM record.

# Inclusion status

## By treatment

```{r by-treatment, echo = FALSE}

adprom %>% 
  filter(fas == "Yes") %>%
  group_by(rantrt) %>%
  summarise(n=n(), .groups = "drop_last") %>%
ggplot(data=., aes(x = rantrt, y = n, fill = rantrt)) +
  geom_bar(stat = "identity") +
  geom_text(aes(label=n), vjust=1.6, color="white",
            position = position_dodge(0.9), size=3.5) +
  scale_fill_manual(values=wes_palette(n=3, name="Darjeeling1")) +
  theme_classic() +
  theme(legend.position = "none") +
  labs(x="", y = "Number randomised (all) in FAS")


adprom %>%
  filter(ranavail_rem == "Yes") %>%
  group_by(rantrt) %>%
  summarise(n=n(), .groups = "drop_last") %>%
ggplot(data=., aes(x = rantrt, y = n, fill = rantrt)) +
  geom_bar(stat = "identity") +
  geom_text(aes(label=n), vjust=1.6, color="white",
            position = position_dodge(0.9), size=3.5) +
  scale_fill_manual(values=wes_palette(n=3, name="Darjeeling1")) +
  theme_classic() +
  theme(legend.position = "none") +
  labs(x="", y = "Number randomised (remdesivir available) in FAS")


adprom_rem <- adprom %>%
    filter(ranavail_rem == "Yes")

```

```{r headers}
arms_tot <- c("Remdesivir", "SOC ± HCQ")
total_n <- n_distinct(adprom$subjectid)

arms_all <- "All patients"

header <- adprom_rem %>%
  group_by(rantrt2, subjectid) %>%
  summarise(n = n(), .groups = "drop_last") %>% 
  group_by(rantrt2) %>%
  summarise(n = n(), .groups = "drop_last") %>%
  ungroup() %>% 
  mutate(armtxt = arms_tot) %>%
  mutate(n_ = c(n[1],  n[2])) %>% 
  mutate(txt = paste0(armtxt, " (N=", n_, ")")) %>%
  select(txt) %>%
  deframe

header_all <- adprom_rem %>% 
  filter(ranavail_rem == "Yes") %>% 
  summarise(n=n(), .groups = "drop_last") %>% 
  mutate(txt = paste0("All patients (N=", n, ")")) %>% 
  select(txt) %>% 
  deframe



```

# Demographics

```{r demographics, warning = FALSE, message = FALSE, results = 'asis', echo = FALSE}

dm_table <- tribble(
  ~text, ~f, ~var, ~param,
  "**Demographics**", "empty", "", list(),
  "  Age (years)", "mean_sd", "age_calc", list(digits = 1),
  "  Female, n (%)", "n_pct", "sex", list(level = "Female"),
  "  Body Mass Index (kg/m^2^)", "mean_sd", "vsbmi", list(digits = 0),
  "  Body Mass Index (kg/m^2^)", "median_iqr", "vsbmi", list(digits = 0),
  "  Symptoms prior to admission (days)", "mean_sd", "sympdur", list(digits = 1),
  "  P/F-ratio at admittance (kPa)", "mean_sd", "rcratio", list(digits = 0),
  "  P/F-ratio < 40kPa, n (%)", "n_pct", "rcratio40", list(level = "Yes"),
  "  Temperature (°C)", "mean_sd", "vstemp", list(digits = 1),
  "  Respiratory rate (breaths/min)", "mean_sd", "vsres", list(digits = 1),
  "  Admitted to ward, n(%)", "n_pct", "sq_admis", list(level = "Ward"),
  "  Admitted to ICU, n(%)", "n_pct", "sq_admis", list(level = "ICU"),
  " WHO Moderate disease state (4-5), n(%)", "n_pct", "rcwhostate", list(level = "Moderate"),
  "  WHO Severe disease state (6-9), n(%)", "n_pct", "rcwhostate", list(level = "Severe"),
  "  WHO Severe disease state (6), n(%)", "n_pct", "rcwhocps", list(level = 6),
  "  WHO Severe disease state (5), n(%)", "n_pct", "rcwhocps", list(level = 5),
    "**Comorbidities**", "empty", "", list(),
  "  Chronic cardiac disease, including congenital heart disease", "n_pct", "cc_card", list(level = "Yes"),
  "  Chronic pulmonary disease, n(%)", "n_pct", "cc_copd", list(level = "Yes"),
  "  Ever smoking, n(%)", "n_pct", "cc_eversmoker", list(level = "Yes"),
  "  Hypertension, n(%)", "n_pct", "cc_ht", list(level = "Yes"),
  "  Diabetes, n(%)", "n_pct", "cc_diab", list(level = "Yes"),
  "  Obese (BMI > 30 kg/m^2^), n(%)", "n_pct", "vsobese", list(level="Obese"),
  "**Co-medications**", "empty", "", list(),
  "  Steroids", "n_pct", "me9", list(level = "Yes"),
  "  Other immunomodulatory drugs", "n_pct", "me10", list(level = "Yes"),
  "  ACE inhibitor", "n_pct", "me1", list(level = "Yes"),
  "  AT-II blockers", "n_pct", "me2", list(level = "Yes"),
  "**Hematology**", "empty", "", list(),
  "  Hemoglobin (g/dL)", "median_iqr", "lbhbres", list(digits = 1),
  "  WBC (x10^9^/L)", "median_iqr", "lbwbcres", list(digits = 1),
  "  Neutrophils (x10^9^/L)", "median_iqr", "lbneures", list(digits = 1),
  "  Lymphocytes (x10^9^/L)", "median_iqr", "lblymres", list(digits = 1),
  "  Platelet counts (x10^9/L)", "median_iqr", "lbpcres", list(digits = 1),
  "**Inflammatory markers**", "empty", "", list(),
  "  CRP (mg/L)", "median_iqr", "lbcrpres", list(digits = 1),
  "  Procalcitonin (µg/L)", "median_iqr", "lbprores", list(digits = 2),
  "  Ferritin (µg/L)", "median_iqr", "lbferres", list(digits = 1),
  "**Other**", "empty", "", list(),
  "  LDH (U/L)", "median_iqr", "lbldres", list(digits = 1),
  "  D-dimer (mg/L FEU)", "median_iqr", "lbdimres1", list(digits = 2),
  "  AST ", "median_iqr", "lbastres", list(digits = 1),
  "  ALT ", "median_iqr", "lbaltres", list(digits = 1),
  "  eGFR (mL/min/1.73 m^2^) ", "median_iqr", "lbegfrc", list(digits = 1),
  "**Viral count**", "empty", "", list(),
  "  Viral count (log~10~ counts/1000 cells)", "mean_sd", "vllog10cpkc", list(digits = 1),
  "**Anti-SARS-CoV-2 Antibodies**", "empty", "", list(),
  "  Sero converted (RBD ≥ 5)", "n_pct", "abseroc", list(level = "RBD ≥ 5"),
  "  Sero converted (Capsid ≥ 10)", "n_pct", "abcapsidd", list(level = "Capsid ≥ 10"),  
  "**Supplementary baseline information**", "empty", "", list(),
  "  Systolic Blood Pressure (mmHg)", "mean_sd", "vssys", list(digits = 0),
  "  Diastolic Blood Pressure (mmHg)", "mean_sd", "vsdia", list(digits = 0),
  "  Mean Arterial Blood Pressure (mmHg)", "mean_sd", "vsmap", list(digits = 0),
  "  SOFA score", "mean_sd", "scsumsc", list(digits = 1),
  "  Chronic kidney disease, n(%)", "n_pct", "cc_ckd", list(level = "Yes"),
  "  Autoimmune disease, n(%)", "n_pct", "cc_aid", list(level = "Yes"),
  "  Cognitive impairment/dementia, n(%)", "n_pct", "cc_cogn", list(level = "Yes"),
  "  Neurological disorder, n(%)", "n_pct", "cc_neur", list(level = "Yes"),
  "  Cancer, n(%)", "n_pct", "cc_cance", list(level = "Yes"),
  "  Cirrhosis, n(%)", "n_pct", "cc_cirr", list(level = "Yes"),
  "  Asthma, n(%)", "n_pct", "cc_asthm", list(level = "Yes"),
  "  HIV, n(%)", "n_pct", "cc_hiv", list(level = "Yes"),
  "  Active TB, n(%)", "n_pct", "cc_tb", list(level = "Yes"),
  "Note, all percentages are given with observed values in the denominator, missing values discarded   ", "empty", "", list()
)



dm_table_f <- function(data2, table_temp, caption, header, group = "rantrt"){
table_temp %>%
  mutate(data = list(data2),
         group = group) %>%
  mutate(res = pmap(list(f, data, var, group, param), stats_exec)) %>%
  mutate(id = map(res,names)) %>%
  unnest(c(res, id)) %>%
  pivot_wider(values_from = res, names_from = id) %>%
   select(text, any_of(levels(data2[[group]])), any_of("Yes")) %>%
   knitr::kable(col.names = c("Parameter", header),
                caption = caption)
  
  
  
}



addm_rem <- adprom %>% 
  select(subjectid, rantrt2) %>% 
  left_join(addm, by = "subjectid")  %>% 
  filter(ranavail_rem == "Yes")   
  




dm_table_f(addm_rem, dm_table, "Demographics, Remdesivir available", header, group = "rantrt2")


```

# Efficacy

## Primary endpoints

### Descriptives

```{r}

descriptives <- function(data = adprom,
                              var = "copd8_m3",
                              digits = 1) {
  var <- ensym(var)
  
  data <- data %>%
    mutate(rantrt = fct_drop(rantrt)) %>%
    select(!!var, subjectid,  rantrt2) %>%
    group_by(rantrt2) %>%
    summarise(
      mean = mean(!!var, na.rm = TRUE),
      sd = sd(!!var, na.rm = TRUE),
      median = median(!!var, na.rm = TRUE),
      q1 = quantile(!!var, 1 / 4, na.rm = TRUE),
      q3 = quantile(!!var, 3 / 4, na.rm = TRUE),
      missing = sum(is.na(!!var)), 
      nonmissing = sum(!is.na(!!var)),
      .groups = "drop_last"
    ) %>%
    ungroup() %>%
    mutate(across(mean:q3, ~ round(., digits = digits))) %>%
    mutate(
      'Mean (SD)' = paste0(mean, " (", sd, ")"),
      'Median [IQR]' = paste0(median, " [", q1, " - ", q3, "]"),
      'Missing / Non-Missing'  = paste0(as.character(missing), " / ", as.character(nonmissing))
    ) %>%
    select(-(mean:nonmissing)) %>%
    pivot_longer('Mean (SD)':'Missing / Non-Missing', names_to = "Statistic") %>%
    select(rantrt2, Statistic, value) %>%
    pivot_wider(
      id_cols = Statistic,
      names_from = rantrt2,
      values_from = value
    )
  
  return(data)
}



primary_vars <- tibble(
  var = c("copd8_m3", "copd4_m3", "copd1_m3"), 
  label = c("CAT Fatigue at 3 months", "CAT shortness of breath at 3 months", "CAT Coughing at 3 months")
)
  
  
 primary_vars %>% 
   mutate(desc = pmap(list(data = list(adprom_rem), var = var, digits = 1), descriptives)) %>% 
   unnest(cols = desc) %>% 
   select(-var) %>% 
   knitr::kable()
  


```

## Primary analysis

### Missingness pattern

```{r}

set.seed(20230518)

cat_imp0 <- adprom_rem %>% 
  filter(ranavail_rem == "Yes") %>% 
  select(subjectid, rantrt, rantrt2, age_calc, sex, hospdur, dphdisc, oxygen, rcwhocps, sympdur, survcens, survtime, rcwhostate, age_cat, age2_cat, sympdur_cat, vl_cat, crp_cat, fer_cat, any_of(starts_with(c("copd"))), total_m1, total_m3) 


cat_imp0 %>% 
  md.pattern(plot = FALSE)


```

We see that a majority of the observations are complete, and the
majority of the missing data are missing primary endpoints. Of the
baseline variables predefined to be used in the imputations, most
missing values are on the hospital duration and discharge due to death.
These will be imputed with proper values.

### Analyses

The primary analyses according to the Statistical Analysis Plan (SAP) is
that the groups will be compared using t-test and the difference in
means will be presented with 95% confidence intervals based on the
t-distribution for the difference. We will implement it using the
lm-function in R.

Missing data due to death will be imputed with worst outcome. Other
missing data will be handled by multiple imputation with chained
equations (MICE). The imputation will be based on a model with the
following covariates:

-   Age
-   Sex
-   Hospital duration
-   Location after discharge (Home with or without requiring municipal
    assistance, recreation stay , municipal rehabilitation/nursing home,
    and local hospital)
-   Baseline WHO Clinical progression scale
-   Symptom duration before admission
-   Viral load at baseline
-   CRP at baseline
-   Ferritin at baseline

Note that treatment is deliberately not part of the imputation model
assuming this will provide conservative estimates of the treatment
effect.

The following sensitivity analyses will be performed:

1\. Equal to the primary analysis but excluding patients randomised to
hydroxychloroquine

2\. Equal to the primary analysis but excluding missing observations
except due to death (complete case analysis)

3\. Equal to the above but comparing using Mann-Whitney U test

```{r}
cat_imp <- cat_imp0 %>% 
  mutate(hospdur = if_else(survcens == "Yes", hospdur, survtime),
         dphdisc = fct_expand(dphdisc, "NA (death)"),
         dphdisc = if_else(survcens == "Yes", dphdisc, "NA (death)"), 
         dphdisc = factor(dphdisc), 
         hospdur = as.numeric(hospdur),
         sympdur = as.numeric(sympdur)) %>% 
  select(-survcens, -survtime)


catimp1 <- mice(cat_imp, maxit = 0)
predM <- catimp1$predictorMatrix

#remove treatment and others from predictor matrix
predM[, c("rantrt2")] <- 0
predM[, c("subjectid")] <- 0
predM[, c("rantrt")] <- 0
predM[, c("age_cat")] <- 0
predM[, c("sympdur_cat")] <- 0


catimp2 <- mice(cat_imp, maxit = 10, predictorMatrix = predM, print = FALSE, m = 10, seed = prom_seed)



analysis <- function(impds, var, digits){
  var <- ensym(var)
  
  res1 <- with(impds, inject(lm(!!var ~ rantrt2))) %>% 
    pool() %>% 
    summary(conf.int = TRUE) %>% 
    filter(str_starts(term, "rantrt2")) %>% 
    mutate(txt = glue(round(estimate, digits = digits), " (95% CI ", round(`2.5 %`, digits = digits), " to ", round(`97.5 %`, digits = digits), ")")) %>% 
    mutate(analysis = "Primary") %>% 
    select(analysis, txt, p.value) 
  
  res2 <- with(impds %>% filter(rantrt != "Hydroxychloroquine + SOC"), inject(lm(!!var ~ rantrt2))) %>% 
    pool() %>% 
    summary(conf.int = TRUE) %>% 
    filter(str_starts(term, "rantrt2")) %>% 
    mutate(txt = glue(round(estimate, digits = digits), " (95% CI ", round(`2.5 %`, digits = digits), " to ", round(`97.5 %`, digits = digits), ")")) %>% 
    mutate(analysis = "HCQ excluded") %>% 
    select(analysis, txt, p.value) 
  
  res3 <- inject(lm(!!var ~ rantrt2, data = impds$data)) %>% 
    tidy(conf.int = TRUE) %>% 
    filter(str_starts(term, "rantrt2")) %>% 
    mutate(txt = glue(round(estimate, digits = digits), " (95% CI ", round(conf.low, digits = digits), " to ", round(conf.high, digits = digits), ")")) %>% 
    mutate(analysis = "Complete case") %>% 
    select(analysis, txt, p.value)
  
  res4 <- inject(wilcox.test(!!var ~ rantrt2, data = impds[["data"]]))
  res4 <- tibble(analysis = "Mann-Whitney U test", p.value = res4$p.value)
  
  res <-  as_tibble(res1) %>% 
    rows_append(res2) %>% 
     rows_append(res3) %>% 
     rows_append(res4) %>% 
  
  return(res)
}

 





primary_vars <- tibble(
  var = c("copd8_m3", "copd4_m3", "copd1_m3"), 
  label = c("CAT Fatigue at 3 months", "CAT shortness of breath at 3 months", "CAT Coughing at 3 months")
)
  
 primary_vars %>% 
   mutate(analysis = pmap(list(impds = list(catimp2), var = var, digits = 2), analysis)) %>% 
   unnest(cols = analysis) %>% 
   select(-var) %>% 
   knitr::kable(caption = "Primary analysis with sensitivity analyses",
               col.names = c("Variable", "Analysis", "Difference with 95% CI", "P-value"))
  


```

### Subgroup analyses

Subgroup analyses will be performed according to the following
subgroups: \*

-   Ventilation at baseline (No or low-flow oxygen vs intensive ventilation)

-   Symptom duration at baseline (\< 7 days vs ≥7 days)

-   Age at baseline (\< 60 vs ≥ 60 years)

-   Age at baseline (\< 65 vs ≥ 65 years)

-   Viral load at baseline (\< overall median vs ≥ overall median)

-   CRP at baseline (\< overall median vs ≥ overall median)

-   Ferritin at baseline (\< overall median vs ≥ overall median)

The subgroup analysis will be performed by an Analysis of Covariance
model including a treatment / subgroup interaction term. Missing data
will be handled using MICE as it was for the primary endpoint.



```{r}



f_subgroup <- function(impds, var, subgroup, digits){
  var <- ensym(var)
  sg <- ensym(subgroup)
  
  res <- with(impds, inject(lm(!!var ~ rantrt2 * !!sg))) 
  
 res_sg <- avg_comparisons(
  res,
  variables = list(rantrt2 = c("Remdesivir", "SOC ± HCQ")),
  by = subgroup

)
  pval <- summary(pool(res)) %>%
    filter(str_detect(term, ":")) %>%
    select( p.value)

  res <- res_sg %>%
    mutate(txt = paste0(round(estimate, digits = digits), " (95% CI ", round(conf.low, digits = digits),
                      " to ", round(conf.high, digits = digits), ")")) %>%
    select(contrast, subgroup, txt, p.value, estimate, conf.low, conf.high ) %>%
    mutate(pval_interaction = as.double(pval)) 

  return(res)
  
}  
  test2 <- f_subgroup(catimp2, copd8_m3, "rcwhostate", digits = 2)
  
  primary_vars <- tibble(
  var = c("copd8_m3", "copd4_m3", "copd1_m3"), 
  label = c("CAT Fatigue at 3 months", "CAT shortness of breath at 3 months", "CAT Coughing at 3 months")
)

subgroup_vars <- tibble(
  subgroup = c("oxygen",  "sympdur_cat", "age_cat", "age2_cat", "vl_cat", "crp_cat", "fer_cat"),
    label_sg = c("Ventilation at baseline",
              "Symptom duration at baseline ",
              "Age at baseline ", 
              "Age at baseline",
              "Viral load at baseline ",
              "CRP at baseline ",
              "Ferritin at baseline ")
)  
  
  
subgroup_vars <-  crossing(primary_vars, subgroup_vars) #%>% 
  #filter(subgroup_ != "rcwhostage")


subgroup_res <- subgroup_vars %>% 
  mutate(result = pmap(list(impds = list(catimp2), var = var, subgroup = subgroup, digits = 2), f_subgroup)) %>% 
  unnest(cols = result) %>% 
  mutate(Category = paste0(age_cat, age2_cat, crp_cat,fer_cat, oxygen, sympdur_cat, vl_cat ),
         Category = str_remove_all(Category, "NA")) %>% 
  mutate(pos = 1)
  



empty <- subgroup_res %>% 
  mutate(pos = -1) %>% 
  mutate(across(4:(ncol(subgroup_res)-1), ~ NA)) %>% 
  unique()



empty2 <- subgroup_res %>% 
  mutate(pos = 0) %>% 
  mutate(across(!any_of(c("var", "label", "subgroup", "label_sg", "pval_interaction", "pos")), ~ NA)) %>% 
  unique()


header <- subgroup_res %>% 
  mutate(across(!any_of(c("var")), ~ NA)) %>% 
  mutate(labtxt = "Subgroup", 
          pval = "p-value interaction",
          pos = -2,
         subgroup = "aaa") %>% 
  unique()

fplot <- subgroup_res %>% 
  add_row(empty) %>% 
  add_row(empty2) %>% 
  mutate(labtxt = if_else(is.na(Category), label_sg, paste0("  ",Category)),
         pval = if_else(is.na(Category), round(pval_interaction, digits = 2), NA),
         pval = as.character(pval)) %>% 
  add_row(header) %>% 
  arrange(var, subgroup, pos)


```


#### Coughing

```{r}


  subgroup_res %>% 
  filter(var == "copd1_m3") %>% 
  select(-var, -subgroup, -estimate, -conf.low, -conf.high) %>%
  select(-ends_with("_cat"), -oxygen, -pos) %>% 
  select(label, label_sg, Category, contrast, everything()) %>% 
   knitr::kable(caption = "Subgroup-analyses",
               col.names = c("Variable", "Subgroup", "Category", "Contrast", "Difference with 95% CI", "P-value", "P-value interaction"))

```

```{r, out.width="100%", fig.cap = "CAT Coughing"}


fplot %>% 
  filter(var == "copd1_m3") %>% 
  forestplot(labeltext = c(labtxt, pval),
             graph.pos = 2,
           mean = estimate, 
           lower = conf.low,
           upper = conf.high,
           title="Difference (95% CI)",
           xlab="<---Placebo Better---    ---Remdesivir Better--->                ",
           hrzl_lines=list("3" = gpar(lwd=1, col="#99999922"),
                          "4" = gpar(lwd=40, lineend="butt",  col="#99999922"),
                          "12" = gpar(lwd=40, lineend="butt",  col="#99999922"),
                          "20" = gpar(lwd=40, lineend="butt",  col="#99999922")
                          ),
           txt_gp=fpTxtGp(label=gpar(cex=0.8),
                              ticks=gpar(cex=1.1),
                              xlab=gpar(cex = 1.0),
                              title=gpar(cex = 1.2)),
           col=fpColors(box="black", lines="black", zero = "gray50"),
           zero=0, cex=0.9, lineheight = "auto", colgap=unit(6,"mm"),
            lwd.ci=2, ci.vertices=TRUE, ci.vertices.height = 0.4, 
           clip = c(-3, 3)
           )

```


#### Shortness of breath
```{r, out.width="100%", fig.cap = "CAT Shortness of breath"}



  subgroup_res %>% 
  filter(var == "copd4_m3") %>% 
  select(-var, -subgroup, -estimate, -conf.low, -conf.high) %>%
  select(-ends_with("_cat"), -oxygen, -pos) %>% 
  select(label, label_sg, Category, contrast, everything()) %>% 
   knitr::kable(caption = "Subgroup-analyses",
               col.names = c("Variable", "Subgroup", "Category", "Contrast", "Difference with 95% CI", "P-value", "P-value interaction"))

fplot %>% 
  filter(var == "copd4_m3") %>% 
  forestplot(labeltext = c(labtxt, pval),
             graph.pos = 2,
           mean = estimate, 
           lower = conf.low,
           upper = conf.high,
           title="Difference (95% CI)",
           xlab="<---Placebo Better---    ---Remdesivir Better--->                ",
           hrzl_lines=list("3" = gpar(lwd=1, col="#99999922"),
                          "4" = gpar(lwd=40, lineend="butt",  col="#99999922"),
                          "12" = gpar(lwd=40, lineend="butt",  col="#99999922"),
                          "20" = gpar(lwd=40, lineend="butt",  col="#99999922")
                          ),
           txt_gp=fpTxtGp(label=gpar(cex=0.8),
                              ticks=gpar(cex=1.1),
                              xlab=gpar(cex = 1.0),
                              title=gpar(cex = 1.2)),
           col=fpColors(box="black", lines="black", zero = "gray50"),
           zero=0, cex=0.9, lineheight = "auto", colgap=unit(6,"mm"),
            lwd.ci=2, ci.vertices=TRUE, ci.vertices.height = 0.4, 
           clip = c(-3, 3)
           )

```


#### Fatigue
```{r , out.width="100%", fig.cap = "CAT Fatigue"}



  subgroup_res %>% 
  filter(var == "copd8_m3") %>% 
  select(-var, -subgroup, -estimate, -conf.low, -conf.high) %>%
  select(-ends_with("_cat"), -oxygen, -pos) %>% 
  select(label, label_sg, Category, contrast, everything()) %>% 
   knitr::kable(caption = "Subgroup-analyses",
               col.names = c("Variable", "Subgroup", "Category", "Contrast", "Difference with 95% CI", "P-value", "P-value interaction"))

fplot %>% 
  filter(var == "copd8_m3") %>% 
  forestplot(labeltext = c(labtxt, pval),
             graph.pos = 2,
           mean = estimate, 
           lower = conf.low,
           upper = conf.high,
           title="Difference (95% CI)",
           xlab="<---Placebo Better---    ---Remdesivir Better--->                ",
           hrzl_lines=list("3" = gpar(lwd=1, col="#99999922"),
                          "4" = gpar(lwd=40, lineend="butt",  col="#99999922"),
                          "12" = gpar(lwd=40, lineend="butt",  col="#99999922"),
                          "20" = gpar(lwd=40, lineend="butt",  col="#99999922")
                          ),
           txt_gp=fpTxtGp(label=gpar(cex=0.8),
                              ticks=gpar(cex=1.1),
                              xlab=gpar(cex = 1.0),
                              title=gpar(cex = 1.2)),
           col=fpColors(box="black", lines="black", zero = "gray50"),
           zero=0, cex=0.9, lineheight = "auto", colgap=unit(6,"mm"),
            lwd.ci=2, ci.vertices=TRUE, ci.vertices.height = 0.4, 
           clip = c(-3, 3)
           )

```


## Secondary endpoints

### Other CAT items including total

```{r}
sec_vars_cat <- tibble(
  var = c("copd8_m1", "copd4_m1", "copd1_m1", "total_m1", "total_m3"), 
  label = c("CAT Fatigue at 1 month", "CAT Shortness of breath at 1 month", "CAT Coughing at 1 month",
            "CAT total score at 1 month", "CAT total score at 3 months")
)

 sec_vars_cat %>% 
   mutate(desc = pmap(list(data = list(adprom_rem), var = var, digits = 1), descriptives)) %>% 
   unnest(cols = desc) %>% 
   select(-var) %>% 
   knitr::kable(caption = "Secondary analyses with CAT Descriptives")


sec_vars_cat %>% 
   mutate(analysis = pmap(list(impds = list(catimp2), var = var, digits = 2), analysis)) %>% 
   unnest(cols = analysis) %>% 
   select(-var) %>% 
   knitr::kable(caption = "Secondary analysis CAT",
               col.names = c("Variable", "Analysis", "Difference with 95% CI", "P-value"))
  

```

### EQ5D outcomes

```{r}
sec_vars_eq5d <- tibble(
  var = c("Eq5d6", "Score_EQ5D"), 
  label = c("EQ-5D-5L self-rated health", "EQ-5D-5L index value ")
)

 sec_vars_eq5d %>% 
   mutate(desc = pmap(list(data = list(adprom_rem), var = var, digits = 1), descriptives)) %>% 
   unnest(cols = desc) %>% 
   select(-var) %>% 
   knitr::kable(caption = "Secondary analyses of EQ5D Descriptives")
 
 
 
eq5d_imp0 <- adprom_rem %>% 
  filter(ranavail_rem == "Yes") %>% 
  select(subjectid, rantrt, rantrt2, age_calc, sex, hospdur, dphdisc, rcwhocps, sympdur, survcens, survtime, rcwhostate, age_cat, sympdur_cat, vl_cat, crp_cat, fer_cat, Eq5d6, Score_EQ5D) 


eq5d_imp <- eq5d_imp0 %>% 
  mutate(hospdur = if_else(survcens == "Yes", hospdur, survtime),
         dphdisc = fct_expand(dphdisc, "NA (death)"),
         dphdisc = if_else(survcens == "Yes", dphdisc, "NA (death)"), 
         dphdisc = factor(dphdisc), 
         hospdur = as.numeric(hospdur),
         sympdur = as.numeric(sympdur)) %>% 
  select(-survcens, -survtime)

eq5dimp1 <- mice(eq5d_imp, maxit = 0)
predM <- eq5dimp1$predictorMatrix

#remove treatment and others from predictor matrix
predM[, c("rantrt2")] <- 0
predM[, c("subjectid")] <- 0
predM[, c("rantrt")] <- 0
predM[, c("age_cat")] <- 0
predM[, c("sympdur_cat")] <- 0


eq5dimp2 <- mice(eq5d_imp, maxit = 10, predictorMatrix = predM, print = FALSE, m = 10, seed = prom_seed)

sec_vars_eq5d %>% 
   mutate(analysis = pmap(list(impds = list(eq5dimp2), var = var, digits = 3), analysis)) %>% 
   unnest(cols = analysis) %>% 
   select(-var) %>% 
   knitr::kable(caption = "EQ5D analyses with sensitivity analyses",
               col.names = c("Variable", "Analysis", "Difference with 95% CI", "P-value"))

```

### SF-36 outcomes

```{r}
sec_vars_sf36 <- tibble(
  var = c("Score_Pf", "Score_Rp","Score_Re","Score_Vt","Score_Mh","Score_Sf","Score_Bp","Score_Gh","Score_Ht"), 
  label = c("SF-36 Physical functioning", "SF-36 Role limitations due to physical health problems", 
            "SF-36 Role limitations due to emotional problems", "SF-36 Energy/fatigue", 
            "SF-36 Emotional well-being", "SF-36 Social functioning", "SF-36 Bodily pain", 
            "SF-36 General health perceptions", "SF-36 Perceived change in health from one year ago")
)

 sec_vars_sf36 %>% 
   mutate(desc = pmap(list(data = list(adprom_rem), var = var, digits = 1), descriptives)) %>% 
   unnest(cols = desc) %>% 
   select(-var) %>% 
   knitr::kable(caption = "Secondary analyses of S36 Descriptives")
 
 
 
sf36_imp0 <- adprom_rem %>% 
  filter(ranavail_rem == "Yes") %>% 
  select(subjectid, rantrt, rantrt2, age_calc, sex, hospdur, dphdisc, rcwhocps, sympdur, survcens, survtime, rcwhostate, age_cat, sympdur_cat, vl_cat, crp_cat, fer_cat, sec_vars_sf36$var) 


sf36_imp <- sf36_imp0 %>% 
  mutate(hospdur = if_else(survcens == "Yes", hospdur, survtime),
         dphdisc = fct_expand(dphdisc, "NA (death)"),
         dphdisc = if_else(survcens == "Yes", dphdisc, "NA (death)"), 
         dphdisc = factor(dphdisc), 
         hospdur = as.numeric(hospdur),
         sympdur = as.numeric(sympdur)) %>% 
  select(-survcens, -survtime)

sf36imp1 <- mice(sf36_imp, maxit = 0)
predM <- sf36imp1$predictorMatrix

#remove treatment and others from predictor matrix
predM[, c("rantrt2")] <- 0
predM[, c("subjectid")] <- 0
predM[, c("rantrt")] <- 0
predM[, c("age_cat")] <- 0
predM[, c("sympdur_cat")] <- 0


sf36imp2 <- mice(sf36_imp, maxit = 10, predictorMatrix = predM, print = FALSE, m = 10, seed = prom_seed)

sec_vars_sf36 %>% 
   mutate(analysis = pmap(list(impds = list(sf36imp2), var = var, digits = 2), analysis)) %>% 
   unnest(cols = analysis) %>% 
   select(-var) %>% 
   knitr::kable(caption = "sf36 analyses with sensitivity analyses",
               col.names = c("Variable", "Analysis", "Difference with 95% CI", "P-value"))

```


# Supplementary analyses

## HCG vs SoC

```{r}

descriptives2 <- function(data = adprom,
                              var = "copd8_m3",
                              digits = 1) {
  var <- ensym(var)
  
  data <- data %>%
    mutate(rantrt = fct_drop(rantrt)) %>%
    select(!!var, subjectid,  rantrt) %>%
    group_by(rantrt) %>%
    summarise(
      mean = mean(!!var, na.rm = TRUE),
      sd = sd(!!var, na.rm = TRUE),
      median = median(!!var, na.rm = TRUE),
      q1 = quantile(!!var, 1 / 4, na.rm = TRUE),
      q3 = quantile(!!var, 3 / 4, na.rm = TRUE),
      missing = sum(is.na(!!var)), 
      nonmissing = sum(!is.na(!!var)),
      .groups = "drop_last"
    ) %>%
    ungroup() %>%
    mutate(across(mean:q3, ~ round(., digits = digits))) %>%
    mutate(
      'Mean (SD)' = paste0(mean, " (", sd, ")"),
      'Median [IQR]' = paste0(median, " [", q1, " - ", q3, "]"),
      'Missing / Non-Missing'  = paste0(as.character(missing), " / ", as.character(nonmissing))
    ) %>%
    select(-(mean:nonmissing)) %>%
    pivot_longer('Mean (SD)':'Missing / Non-Missing', names_to = "Statistic") %>%
    select(rantrt, Statistic, value) %>%
    pivot_wider(
      id_cols = Statistic,
      names_from = rantrt,
      values_from = value
    )
  
  return(data)
}



primary_vars <- tibble(
  var = c("copd8_m3", "copd4_m3", "copd1_m3"), 
  label = c("CAT Fatigue at 3 months", "CAT shortness of breath at 3 months", "CAT Coughing at 3 months")
)
  
  
 primary_vars %>% 
   mutate(desc = pmap(list(data = list(adprom_rem %>% filter(rantrt != "Remdesivir + SOC")), var = var, digits = 1), descriptives2)) %>% 
   unnest(cols = desc) %>% 
   select(-var) %>% 
   knitr::kable()
  




analysis_sup <- function(impds, var, digits){
  var <- ensym(var)
  
  res2 <- with(impds %>% 
                 filter(rantrt != "Remdesivir + SOC"), inject(lm(!!var ~ rantrt))) %>% 
    pool() %>% 
    summary(conf.int = TRUE) %>% 
    filter(str_starts(term, "rantrt")) %>% 
    mutate(txt = glue(round(estimate, digits = digits), " (95% CI ", round(`2.5 %`, digits = digits), " to ", round(`97.5 %`, digits = digits), ")")) %>% 
    mutate(analysis = "SOC vs HCQ") %>% 
    select(analysis, txt, p.value) 
  
  
  res <-  as_tibble(res2) 
  
  return(res)
}



tmp <- analysis_sup(catimp2, "copd1_m3", digits = 2)
  
tmp<- primary_vars %>% 
   mutate(analysis = pmap(list(impds = list(catimp2), var = var, digits = 2), analysis_sup)) %>% 
   unnest(cols = analysis) %>% 
   select(-var) %>% 
   knitr::kable(caption = "Supplementary analysis, HCQ vs SoC",
               col.names = c("Variable", "Analysis", "Difference with 95% CI", "P-value"))
  
tmp
```

# Communications Medicine review

# Ref1 comment 2

Reviewer's comment: "I have a major issue regarding the handling of missing data due to death. Imputing data with worst outcome seems highly biased, as it could possibly hide a potential efficacy or suggest a potential harm of treatment where none exists. I would suggest the authors use another imputation method to handle these data. Especially, adaptations of the MICE algorithms have been specially developed to handle MNAR data, such as NARFCS (see PMID: 29611205)."

While we disagree with the reviewer on this point, we will do the analysis using the suggested method (NARFCS). We use standard multiple imputation with chained equations as defined in the primary analysis, but put a shift on the imputed values for subjects who had missing data due to death. We used shift parameters of 

```{r}


rev_cat_imp0 <- adprom_noimp %>% 
  filter(ranavail_rem == "Yes") %>% 
  select(subjectid, rantrt, rantrt2, age_calc, sex, hospdur, dphdisc, rcwhocps, sympdur, survcens, survtime, rcwhostate, age_cat, sympdur_cat, vl_cat, crp_cat, fer_cat, any_of(starts_with(c("copd"))), total_m1, total_m3) 

rev_cat_imp <- rev_cat_imp0 %>% 
  mutate(hospdur = if_else(survcens == "Yes", hospdur, survtime),
         dphdisc = fct_expand(dphdisc, "NA (death)"),
         dphdisc = if_else(survcens == "Yes", dphdisc, "NA (death)"), 
         dphdisc = factor(dphdisc), 
         hospdur = as.numeric(hospdur),
         sympdur = as.numeric(sympdur),
         dphdisc = fct_recode(dphdisc, H1 = "Home", H2 = "Home, requiring municipal assistance",  Reh = "Municipal rehabilitation/nursing home", Death = "NA (death)", Rec = "Recreation stay")) %>% 
  select(-survcens, -survtime) %>% 
  select(subjectid:fer_cat, copd8_m3, copd4_m3, copd1_m3) 


rev_catimp1 <- mice(rev_cat_imp, maxit = 0)
rev_predM <- rev_catimp1$predictorMatrix

#remove treatment and others from predictor matrix
rev_predM[, c("rantrt2")] <- 0
rev_predM[, c("subjectid")] <- 0
rev_predM[, c("rantrt")] <- 0
rev_predM[, c("age_cat")] <- 0
rev_predM[, c("sympdur_cat")] <- 0

mortality <- rev_cat_imp %>% 
  mutate(mort = if_else(dphdisc=="Death", 1, 0, 0)) %>% 
  select(mort) %>% 
  as.matrix()

methods1 <- rev_catimp1$method
mnar_methods <- methods1 %>% 
  enframe() %>% 
  mutate(value = if_else(value == "pmm" & str_detect(name, "copd"), "mnar.norm", value)) %>% 
  deframe()

mnar.blot1 <- list(
copd1_m3 = list(ums = "0+1*mort", umx = mortality),
copd4_m3 = list(ums = "0+1*mort", umx = mortality),
copd8_m3 = list(ums = "0+1*mort", umx = mortality))

mnar.blot2 <- list(
copd1_m3 = list(ums = "0+2*mort", umx = mortality),
copd4_m3 = list(ums = "0+2*mort", umx = mortality),
copd8_m3 = list(ums = "0+2*mort", umx = mortality))

mnar.blot3 <- list(
copd1_m3 = list(ums = "0+3*mort", umx = mortality),
copd4_m3 = list(ums = "0+3*mort", umx = mortality),
copd8_m3 = list(ums = "0+3*mort", umx = mortality))


rev_catimp1 <- mice(rev_cat_imp, maxit = 10, method = mnar_methods,  print = FALSE, blots = mnar.blot1, m = 10, seed = prom_seed)

rev_catimp2 <- mice(rev_cat_imp, maxit = 10, method = mnar_methods,  print = FALSE, blots = mnar.blot2, m = 10, seed = prom_seed)

rev_catimp3 <- mice(rev_cat_imp, maxit = 10, method = mnar_methods,  print = FALSE, blots = mnar.blot3, m = 10, seed = prom_seed)

rev_primary_vars <- tibble(
  var = c("copd8_m3", "copd4_m3", "copd1_m3"), 
  label = c("CAT Fatigue at 3 months", "CAT shortness of breath at 3 months", "CAT Coughing at 3 months")
)
  


rev_primary_vars %>% 
   mutate(analysis = pmap(list(impds = list(rev_catimp1), var = var, digits = 2), analysis)) %>% 
   unnest(cols = analysis) %>% 
   select(-var) %>% 
   knitr::kable(caption = "Sensitivity estimands of the primary analysis using NARFCS with shift-parameter delta = 1",
               col.names = c("Variable", "Analysis", "Difference with 95% CI", "P-value"))
  

rev_primary_vars %>% 
   mutate(analysis = pmap(list(impds = list(rev_catimp2), var = var, digits = 2), analysis)) %>% 
   unnest(cols = analysis) %>% 
   select(-var) %>% 
   knitr::kable(caption = "Sensitivity estimands of the primary analysis using NARFCS with shift-parameter delta = 2",
               col.names = c("Variable", "Analysis", "Difference with 95% CI", "P-value"))
  

rev_primary_vars %>% 
   mutate(analysis = pmap(list(impds = list(rev_catimp3), var = var, digits = 2), analysis)) %>% 
   unnest(cols = analysis) %>% 
   select(-var) %>% 
   knitr::kable(caption = "Sensitivity estimands of the primary analysis using NARFCS with shift-parameter delta = 3",
               col.names = c("Variable", "Analysis", "Difference with 95% CI", "P-value"))
  


```
## Ref 1 comment 4

Comment: "A recent meta-analysis (PMID: 36828006) showed that remdesivir could reduce mortality in hospitalized patients depending on the oxygen support needed. Could the authors perform a supplementary subgroup analysis regarding this stratum?"

Added a sub-group analysis on 1) No ventilation at baseline: No or only low−flow oxygen or 2) Ventilation at baseline: High−flow or non−invasive ventilation, mechanical ventilation, ECMO
See subgroup analysis

## Ref 2 Comment 2

Comment: - The trial is open label, which may pose problems of performance bias and measurement bias. This is mentionned in limitations. If the data is available, it would be interesting to know and compare co-interventions received in the two groups (I believe that Table 1 only reports cointerventions at baseline)


Add an overview of co-medication while hospitalised. 

```{r, include = FALSE}
cm <- raw %>% 
  pick("cm")

items <- raw %>% pick("items")

tdcm <- raw %>% pick("cm") %>% 
  left_join(pick(raw,"atc_without_ddd")) %>% 
  select(-(eventid:designversion), -(siteseq:subjectseq), -(formid:itemname)) %>% 
  labeliser() %>% 
  arrange(subjectid, cmspid) 

adcm <- cat_imp %>% 
  select(subjectid,  rantrt2) %>% 
  left_join(tdcm, by = "subjectid") %>% 
  mutate(cmtype = fct_na_value_to_level(cmtype),
         l5name = factor(l5name),
         l5name = fct_na_value_to_level(l5name))

tmp <- adcm %>% 
  group_by(subjectid, rantrt2, cmtype, l5name) %>% 
  summarise(n = n()) %>% 
  group_by(rantrt2, cmtype, l5name) %>% 
  summarise(n=n()) %>% 
  mutate(pct = case_when(
    rantrt2 == "SOC ± HCQ" ~ round(n/76*100, digits = 1),
    rantrt2 == "Remdesivir" ~ round(n/42*100, digits = 1)),
    txt = paste0(n, " (", pct, "%)")) %>% 
  select(-n, -pct) %>% 
   pivot_wider(names_from = rantrt2, values_from = txt, values_fill = "0 (0.0%)") 


```


```{r}
tmp %>% 
  arrange(cmtype, l5name) %>% 
  knitr::kable()
```

## Ref 2 Comment 3


- recruitment occured from March to October 2020, a period during which, there has been a lot a change in the way patients were cared for in terms of oxygenotherapy, cointerventions etc.) Because the trial is small, it is not excluded that there may be imabalance in terms of periods of inclusion. Can you check the balance in terms of period of inclusion in the two arms ?

Plot Kaplan-Meier plot of the inclusion

The slight difference seen is due to the 1:1:1 between HCQ:Remdesivir:SoC the first 40 days after remdesivir was available. This lead to a 2:1 randomisation between the two groups in this period. Between  day 40 and the end the randomisation was 1:1 between Remdesivir and SoC. 
```{r}



library(ggsurvfit)
tmp <- adprom_rem %>% 
  select(rantrt2, rantrt, randt) %>% 
  mutate(time = randt -min(randt),
         status = 1) %>%
  arrange(rantrt2, time) %>% 
  group_by(rantrt2) %>% 
  mutate(csum = cumsum(status)) 


ggplot(data = tmp, mapping= aes(x = time, y = csum, color = rantrt2 )) +
  geom_line() + 
  labs(
    x = "Days since first participant randomised",
    y = "Inclusion rate",
    color = "Group"
  )

survfit2(Surv(time, status) ~ rantrt2, data = tmp) %>% 
  ggsurvfit(type = "risk") + 
  add_pvalue() + 
  labs(
    x = "Days since first participant randomised",
    y = "Inclusion rate"
  )



```

## Ref 2 Comment 4
Analysis is on full analysis set. I suggest to add Intent to treat. It is also mandatory to report the number of patients randomized without at least one post-randomisation observation to understand how different was the sample was.

```{r}
adsl_all %>% 
  filter(randomised == "Yes") %>% 
  group_by(ranavail_rem, fas, rantrt) %>% 
  summarise(n=n())

```
So, 122 was randomised, and 4 were excluded from the full analysis set due to no post-randomisation observations.








